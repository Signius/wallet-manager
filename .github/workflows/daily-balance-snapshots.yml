name: Wallet Snapshots (4h) + Threshold Alerts

# This workflow takes daily snapshots of wallet balances and stores them in the database.
# API requests require SNAPSHOT_AUTH_TOKEN secret to be set in GitHub repository settings.

on:
  schedule:
    # Every 4 hours (UTC)
    - cron: '0 */4 * * *'
  # Allow manual triggering for testing
  workflow_dispatch:

jobs:
  snapshot-balances:
    runs-on: ubuntu-latest
    timeout-minutes: 300  # 5 hours timeout (GitHub Actions max is 6 hours)
    permissions:
      contents: write  # Required to commit and push changes to README
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install script dependencies
        run: |
          cd scripts
          npm install
        
      - name: Run batch snapshot orchestration
        run: |
          cd scripts
          npm start
        env:
          API_BASE_URL: ${{ secrets.API_BASE_URL }}
          SNAPSHOT_AUTH_TOKEN: ${{ secrets.SNAPSHOT_AUTH_TOKEN }}
          BATCH_SIZE: 10
          DELAY_BETWEEN_BATCHES: 5
          MAX_RETRIES: 3

      - name: Check thresholds + send Discord alerts
        run: |
          curl -sS -X GET "${API_BASE_URL}/api/check-thresholds" \
            -H "Accept: application/json" \
            -H "Authorization: Bearer ${SNAPSHOT_AUTH_TOKEN}"
        env:
          API_BASE_URL: ${{ secrets.API_BASE_URL }}
          SNAPSHOT_AUTH_TOKEN: ${{ secrets.SNAPSHOT_AUTH_TOKEN }}

      - name: Update README with last snapshot timestamp
        continue-on-error: true
        run: |
          # Get current timestamp in UTC
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          # Update README.md with the timestamp (Linux sed syntax for ubuntu-latest)
          sed -i "s/Last wallet balance snapshot: \`.*\`/Last wallet balance snapshot: \`$TIMESTAMP\`/" README.md
          
          # Configure git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Commit and push if there are changes
          git diff --quiet README.md || {
            git add README.md
            git commit -m "Update last snapshot timestamp: $TIMESTAMP"
            git push
          }

      - name: Notify on failure
        if: failure()
        # Send failure notification
        run: |
          echo "❌ Daily balance snapshot job failed"
          if [ -n "${{ secrets.SNAPSHOT_ERROR_DISCORD_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"❌ Daily balance snapshots failed. Check the GitHub Actions logs.\"}" \
              ${{ secrets.SNAPSHOT_ERROR_DISCORD_WEBHOOK_URL }} || echo "Failed to send Discord notification"
          else
            echo "SNAPSHOT_ERROR_DISCORD_WEBHOOK_URL not configured, skipping notification"
          fi
