name: Wallet Snapshots (4h) + Threshold Alerts

# This workflow takes daily snapshots of wallet balances and stores them in the database.
# API requests require SNAPSHOT_AUTH_TOKEN secret to be set in GitHub repository settings.

on:
  schedule:
    # Every 4 hours (UTC)
    - cron: '0 */4 * * *'
  # Allow manual triggering for testing
  workflow_dispatch:

jobs:
  snapshot-balances:
    runs-on: ubuntu-latest
    timeout-minutes: 300  # 5 hours timeout (GitHub Actions max is 6 hours)
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install script dependencies
        run: |
          cd scripts
          npm install
        
      - name: Run batch snapshot orchestration
        run: |
          cd scripts
          npm start
        env:
          API_BASE_URL: "https://frolicking-nougat-61d6aa.netlify.app"
          SNAPSHOT_AUTH_TOKEN: ${{ secrets.SNAPSHOT_AUTH_TOKEN }}
          BATCH_SIZE: 10
          DELAY_BETWEEN_BATCHES: 5
          MAX_RETRIES: 3

      - name: Check thresholds + send Discord alerts
        run: |
          curl -sS -X GET "${API_BASE_URL}/api/check-thresholds" \
            -H "Accept: application/json" \
            -H "Authorization: Bearer ${SNAPSHOT_AUTH_TOKEN}"
        env:
          API_BASE_URL: "https://frolicking-nougat-61d6aa.netlify.app"
          SNAPSHOT_AUTH_TOKEN: ${{ secrets.SNAPSHOT_AUTH_TOKEN }}

      - name: Notify on failure
        if: failure()
        # Send failure notification
        run: |
          echo "❌ Daily balance snapshot job failed"
          if [ -n "${{ secrets.SNAPSHOT_ERROR_DISCORD_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"❌ Daily balance snapshots failed. Check the GitHub Actions logs.\"}" \
              ${{ secrets.SNAPSHOT_ERROR_DISCORD_WEBHOOK_URL }} || echo "Failed to send Discord notification"
          else
            echo "SNAPSHOT_ERROR_DISCORD_WEBHOOK_URL not configured, skipping notification"
          fi
